# YOLO å¾Œè™•ç†é‚è¼¯èˆ‡æª¢æ¸¬è…³æœ¬å®Œæ•´æŒ‡å—

æœ¬æŒ‡å—è©³ç´°è§£é‡‹ YOLOv8 å¾Œè™•ç†é‚è¼¯å’Œæª¢æ¸¬è…³æœ¬çš„å·¥ä½œåŸç†ï¼Œå¹«åŠ©æ‚¨ç†è§£æ•´å€‹æª¢æ¸¬æµç¨‹ã€‚

## ç›®éŒ„
1. [æ•´é«”æ¶æ§‹æ¦‚è¦½](#æ•´é«”æ¶æ§‹æ¦‚è¦½)
2. [yolo_detect_images.py è…³æœ¬ç”¨é€”](#yolo_detect_imagesè…³æœ¬ç”¨é€”)
3. [yoloraw_postprocessing.py é‚è¼¯è©³è§£](#yoloraw_postprocessingé‚è¼¯è©³è§£)
4. [é—œéµåƒæ•¸èªªæ˜](#é—œéµåƒæ•¸èªªæ˜)
5. [æª¢æ¸¬é‚è¼¯æµç¨‹](#æª¢æ¸¬é‚è¼¯æµç¨‹)
6. [ä½¿ç”¨ç¯„ä¾‹èˆ‡èª¿å„ªå»ºè­°](#ä½¿ç”¨ç¯„ä¾‹èˆ‡èª¿å„ªå»ºè­°)

---

## æ•´é«”æ¶æ§‹æ¦‚è¦½

### ç³»çµ±çµ„æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   yolo_detect_images.py â”‚  â† ä¸»åŸ·è¡Œè…³æœ¬
â”‚   (ä¸»è¦å…¥å£é»)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ å‘¼å«
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ yoloraw_postprocessing.pyâ”‚  â† å¾Œè™•ç†æ ¸å¿ƒé‚è¼¯
â”‚   (è¤‡é›œå¾Œè™•ç†é‚è¼¯)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å°ˆæ¡ˆç‰¹è‰²
é€™æ˜¯ä¸€å€‹**å¯¶è—èˆ‡åœ°æ¨™æª¢æ¸¬ç³»çµ±**ï¼Œå°ˆé–€è¨­è¨ˆç”¨æ–¼æª¢æ¸¬å…©é¡ç‰©ä»¶ï¼š
- **å¯¶è—é¡åˆ¥**ï¼šcrystalï¼ˆæ°´æ™¶ï¼‰ã€diamondï¼ˆé‘½çŸ³ï¼‰ã€emeraldï¼ˆç¶ å¯¶çŸ³ï¼‰
- **åœ°æ¨™é¡åˆ¥**ï¼šcoinï¼ˆç¡¬å¹£ï¼‰ã€compassï¼ˆæŒ‡å—é‡ï¼‰ã€coralï¼ˆçŠç‘šï¼‰ã€fossilï¼ˆåŒ–çŸ³ï¼‰ã€keyï¼ˆé‘°åŒ™ï¼‰ã€letterï¼ˆä¿¡ä»¶ï¼‰ã€shellï¼ˆè²æ®¼ï¼‰ã€treasure_boxï¼ˆå¯¶ç®±ï¼‰

---

## yolo_detect_images.py è…³æœ¬ç”¨é€”

### ğŸ¯ ä¸»è¦åŠŸèƒ½
é€™æ˜¯æ•´å€‹æª¢æ¸¬ç³»çµ±çš„**ä¸»å…¥å£é»**ï¼Œè² è²¬ï¼š
1. **è¨­å®šæª¢æ¸¬åƒæ•¸**
2. **è¼‰å…¥åœ–ç‰‡å’Œæ¨¡å‹**
3. **åŸ·è¡Œæª¢æ¸¬æµç¨‹**
4. **è¼¸å‡ºçµæœçµ±è¨ˆ**

### ğŸ“ è…³æœ¬çµæ§‹è§£æ

```python
# 1. æª”æ¡ˆè·¯å¾‘è¨­å®š
model_path = r'path/to/best.pt'           # è¨“ç·´å¥½çš„æ¨¡å‹æ¬Šé‡
image_base_folder = r'path/to/images'     # åœ–ç‰‡è³‡æ–™å¤¾
image_names = ['image1.png', 'image2.png'] # è¦æª¢æ¸¬çš„åœ–ç‰‡æ¸…å–®

# 2. æª¢æ¸¬åƒæ•¸è¨­å®š
img_type = "lost"                         # æª¢æ¸¬é¡å‹ï¼š"lost" æˆ– "target"
img_size = 320                           # åœ–ç‰‡å°ºå¯¸ï¼ˆå¿…é ˆèˆ‡è¨“ç·´æ™‚ä¸€è‡´ï¼‰
conf_threshold = 0.3                     # ä¿¡å¿ƒåº¦é–¾å€¼
standard_nms_threshold = 0.45            # æ¨™æº– NMS é–¾å€¼
overlap_nms_threshold = 0.8              # é‡ç–Š NMS é–¾å€¼

# 3. åŸ·è¡Œæª¢æ¸¬
detections = simple_detection_example(...)

# 4. çµæœè™•ç†
report_landmark = []    # åœ°æ¨™æ•¸é‡çµ±è¨ˆ
store_treasure = []     # å¯¶è—é¡å‹çµ±è¨ˆ
```

### ğŸ”§ é—œéµè®Šæ•¸èªªæ˜

| è®Šæ•¸ | åŠŸèƒ½ | é‡è¦æ€§ |
|------|------|--------|
| `img_type` | æ±ºå®šæª¢æ¸¬é‚è¼¯æ¨¡å¼ | â­â­â­ |
| `img_size` | å¿…é ˆèˆ‡è¨“ç·´æ™‚ä¸€è‡´ | â­â­â­ |
| `conf_threshold` | éæ¿¾ä½ä¿¡å¿ƒåº¦æª¢æ¸¬ | â­â­ |
| `standard_nms_threshold` | ç§»é™¤é‡ç–Šçš„ä¸åŒé¡åˆ¥ç‰©ä»¶ | â­â­ |
| `overlap_nms_threshold` | å…è¨±åŒé¡åˆ¥ç‰©ä»¶å †ç–Š | â­â­ |

---

## yoloraw_postprocessing.py é‚è¼¯è©³è§£

### ğŸ—ï¸ æ¨¡çµ„æ¶æ§‹

```
yoloraw_postprocessing.py
â”œâ”€â”€ convert_detections_to_final_format()     # æ ¼å¼è½‰æ›
â”œâ”€â”€ apply_standard_nms()                     # æ¨™æº– NMS
â”œâ”€â”€ apply_landmark_intelligent_nms()         # æ™ºèƒ½ NMS  
â”œâ”€â”€ yolo_postprocess_pipeline()              # ä¸»è™•ç†æµç¨‹
â”œâ”€â”€ load_image_path()                        # åœ–ç‰‡è¼‰å…¥
â”œâ”€â”€ get_raw_yolo_tensor_flexible()           # ç²å–åŸå§‹è¼¸å‡º
â”œâ”€â”€ deal_with_result_detections()            # çµæœè™•ç†
â””â”€â”€ simple_detection_example()               # ç°¡åŒ–æ¥å£
```

### ğŸ“Š è³‡æ–™æµç¨‹åœ–

```
åŸå§‹åœ–ç‰‡ â†’ YOLOæ¨¡å‹ â†’ åŸå§‹å¼µé‡ â†’ å¾Œè™•ç†ç®¡é“ â†’ æœ€çµ‚çµæœ
   â†“          â†“          â†“           â†“          â†“
[H,W,C]   [1,15,2100] [1,2100,15]  æ™ºèƒ½NMS   æª¢æ¸¬æ¸…å–®
```

### ğŸ§  æ ¸å¿ƒå‡½æ•¸è©³è§£

#### 1. `yolo_postprocess_pipeline()` - ä¸»è™•ç†æµç¨‹

é€™æ˜¯æœ€é‡è¦çš„å‡½æ•¸ï¼Œè™•ç†æ•´å€‹å¾Œè™•ç†é‚è¼¯ï¼š

```python
def yolo_postprocess_pipeline(raw_tensor, conf_threshold, nms_thresholds, img_size, imgtype):
    # Step 1: å¼µé‡æ ¼å¼è½‰æ›
    # Step 2: æ‡‰ç”¨ä¿¡å¿ƒåº¦é–¾å€¼
    # Step 3: åˆ†é›¢å¯¶è—èˆ‡åœ°æ¨™æª¢æ¸¬
    # Step 4: æ ¹æ“šåœ–ç‰‡é¡å‹æ‡‰ç”¨ä¸åŒé‚è¼¯
    # Step 5: æ™ºèƒ½ NMS è™•ç†
    # Step 6: æœ€çµ‚çµæœé¸æ“‡
```

**è™•ç†æ­¥é©Ÿè©³è§£ï¼š**

1. **å¼µé‡æ ¼å¼è½‰æ›**
   - è¼¸å…¥ï¼š`[1, 15, 2100]` â†’ è¼¸å‡ºï¼š`[1, 2100, 15]`
   - 15 = 4ï¼ˆé‚Šç•Œæ¡†åº§æ¨™ï¼‰+ 11ï¼ˆé¡åˆ¥åˆ†æ•¸ï¼‰
   - 2100 = 10Ã—10 + 20Ã—20 + 40Ã—40ï¼ˆä¸åŒå°ºåº¦çš„éŒ¨é»ç¸½æ•¸ï¼‰

2. **ä¿¡å¿ƒåº¦éæ¿¾**
   - åªä¿ç•™ä¿¡å¿ƒåº¦ > `conf_threshold` çš„æª¢æ¸¬
   - æ¯å€‹æª¢æ¸¬å¯èƒ½å°æ‡‰å¤šå€‹é¡åˆ¥

3. **é¡åˆ¥åˆ†é›¢**
   - **å¯¶è—æª¢æ¸¬**ï¼šcrystalã€diamondã€emerald
   - **åœ°æ¨™æª¢æ¸¬**ï¼šcoinã€compassã€coralã€fossilã€keyã€letterã€shellã€treasure_box

#### 2. `apply_standard_nms()` - æ¨™æº–éæ¥µå¤§å€¼æŠ‘åˆ¶

```python
def apply_standard_nms(detections, nms_threshold):
    # ç”¨æ–¼ç§»é™¤é‡ç–Šçš„ä¸åŒé¡åˆ¥ç‰©ä»¶
    # é©ç”¨æ–¼å¯¶è—æª¢æ¸¬ï¼ˆä¸åŒå¯¶è—ä¸æ‡‰é‡ç–Šï¼‰
```

**ä½¿ç”¨æ™‚æ©Ÿï¼š**
- å¯¶è—æª¢æ¸¬ï¼ˆä¸åŒå¯¶è—é¡å‹ä¸æ‡‰è©²åœ¨åŒä¸€ä½ç½®ï¼‰
- Target æ¨¡å¼çš„åœ°æ¨™æª¢æ¸¬

#### 3. `apply_landmark_intelligent_nms()` - æ™ºèƒ½éæ¥µå¤§å€¼æŠ‘åˆ¶

```python
def apply_landmark_intelligent_nms(detections, overlap_nms_threshold):
    # æ™ºèƒ½è™•ç†åœ°æ¨™å †ç–Šæƒ…æ³
    # 1. é¸æ“‡ä¿¡å¿ƒåº¦æœ€é«˜çš„é¡åˆ¥
    # 2. åªä¿ç•™è©²é¡åˆ¥çš„æª¢æ¸¬
    # 3. å…è¨±åŒé¡åˆ¥ç‰©ä»¶é©åº¦é‡ç–Š
```

**æ™ºèƒ½é‚è¼¯ï¼š**
1. æ‰¾å‡ºä¿¡å¿ƒåº¦æœ€é«˜çš„æª¢æ¸¬åŠå…¶é¡åˆ¥
2. éæ¿¾å‡ºåŒé¡åˆ¥çš„æ‰€æœ‰æª¢æ¸¬
3. å°åŒé¡åˆ¥æª¢æ¸¬æ‡‰ç”¨è¼ƒå¯¬é¬†çš„ NMSï¼ˆå…è¨±å †ç–Šï¼‰

---

## é—œéµåƒæ•¸èªªæ˜

### ğŸ“Š ä¿¡å¿ƒåº¦é–¾å€¼ (conf_threshold)

| æ•¸å€¼ | æ•ˆæœ | é©ç”¨å ´æ™¯ |
|------|------|----------|
| 0.1-0.2 | æª¢æ¸¬æ•æ„Ÿï¼Œå¯èƒ½æœ‰èª¤æª¢ | ä¸éºæ¼ä»»ä½•å¯èƒ½ç›®æ¨™ |
| 0.3-0.5 | å¹³è¡¡æª¢æ¸¬èˆ‡æº–ç¢ºæ€§ | **æ¨è–¦è¨­å®š** |
| 0.6-0.9 | é«˜æº–ç¢ºæ€§ï¼Œå¯èƒ½éºæ¼ | åªè¦é«˜ä¿¡å¿ƒåº¦æª¢æ¸¬ |

### ğŸ”§ NMS é–¾å€¼è¨­å®š

#### standard_nms_threshold (0.45)
- **ç”¨é€”**ï¼šç§»é™¤ä¸åŒé¡åˆ¥é–“çš„é‡ç–Š
- **åŸç†**ï¼šIoU > é–¾å€¼çš„æª¢æ¸¬æœƒè¢«ç§»é™¤
- **å»ºè­°**ï¼š0.3-0.6

#### overlap_nms_threshold (0.8)
- **ç”¨é€”**ï¼šå…è¨±åŒé¡åˆ¥ç‰©ä»¶å †ç–Š
- **åŸç†**ï¼šè¼ƒé«˜é–¾å€¼å…è¨±æ›´å¤šé‡ç–Š
- **å»ºè­°**ï¼š0.6-0.9

---

## æª¢æ¸¬é‚è¼¯æµç¨‹

### ğŸ¯ Target æ¨¡å¼ (img_type="target")

**ç›®æ¨™**ï¼šæª¢æ¸¬ 1 å€‹å¯¶è— + 2 å€‹ä¸åŒé¡å‹çš„åœ°æ¨™

```mermaid
graph TD
    A[åŸå§‹æª¢æ¸¬] --> B[æ¨™æº–NMS - å¯¶è—]
    A --> C[æ¨™æº–NMS - åœ°æ¨™]
    B --> D[é¸æ“‡æœ€é«˜ä¿¡å¿ƒåº¦å¯¶è—]
    C --> E[é¸æ“‡å‰2å€‹ä¸åŒé¡å‹åœ°æ¨™]
    D --> F[æœ€çµ‚çµæœ: 1å¯¶è—+2åœ°æ¨™]
    E --> F
```

**é‚è¼¯ç‰¹é»ï¼š**
- å¯¶è—å’Œåœ°æ¨™éƒ½ä½¿ç”¨æ¨™æº– NMS
- åš´æ ¼é¸æ“‡ï¼š1 å¯¶è— + 2 ä¸åŒåœ°æ¨™é¡å‹
- é©ç”¨æ–¼å°‹æ‰¾ç‰¹å®šç›®æ¨™çš„å ´æ™¯

### ğŸ” Lost æ¨¡å¼ (img_type="lost")

**ç›®æ¨™**ï¼šæª¢æ¸¬ 1 å€‹åœ°æ¨™ OR 1 å€‹åœ°æ¨™ + 1 å€‹å¯¶è—

```mermaid
graph TD
    A[åŸå§‹æª¢æ¸¬] --> B{æœ‰å¯¶è—æª¢æ¸¬?}
    B -->|æ˜¯| C[æ¨™æº–NMS - å¯¶è—]
    B -->|æ˜¯| D[æ™ºèƒ½NMS - åœ°æ¨™]
    B -->|å¦| E[æ™ºèƒ½NMS - åœ°æ¨™]
    C --> F[é¸æ“‡1å¯¶è—+1åœ°æ¨™]
    D --> F
    E --> G[é¸æ“‡1åœ°æ¨™]
    F --> H[æœ€çµ‚çµæœ]
    G --> H
```

**é‚è¼¯ç‰¹é»ï¼š**
- å¯¶è—ä½¿ç”¨æ¨™æº– NMS
- åœ°æ¨™ä½¿ç”¨æ™ºèƒ½ NMSï¼ˆå…è¨±å †ç–Šï¼‰
- å½ˆæ€§é¸æ“‡ï¼šå¯ä»¥åªæœ‰åœ°æ¨™ï¼Œä¹Ÿå¯ä»¥æœ‰å¯¶è—+åœ°æ¨™
- é©ç”¨æ–¼å°‹æ‰¾éºå¤±ç‰©å“çš„å ´æ™¯

### ğŸ§  æ™ºèƒ½ NMS çš„ç¨ç‰¹ä¹‹è™•

**å‚³çµ± NMS å•é¡Œï¼š**
- æœƒç§»é™¤æ‰€æœ‰é‡ç–Šçš„æª¢æ¸¬ï¼ŒåŒ…æ‹¬åŒé¡åˆ¥çš„å †ç–Šç‰©ä»¶
- å¯èƒ½å°è‡´éºæ¼çœŸå¯¦çš„ç‰©ä»¶å †ç–Šæƒ…æ³

**æ™ºèƒ½ NMS è§£æ±ºæ–¹æ¡ˆï¼š**
1. **é¡åˆ¥çµ±ä¸€**ï¼šåªä¿ç•™ä¿¡å¿ƒåº¦æœ€é«˜é¡åˆ¥çš„æª¢æ¸¬
2. **å…è¨±å †ç–Š**ï¼šä½¿ç”¨è¼ƒé«˜çš„ IoU é–¾å€¼
3. **æ•¸é‡ä¿ç•™**ï¼šä¿ç•™åˆç†æ•¸é‡çš„åŒé¡åˆ¥æª¢æ¸¬

---

## ä½¿ç”¨ç¯„ä¾‹èˆ‡èª¿å„ªå»ºè­°

### ğŸš€ åŸºæœ¬ä½¿ç”¨ç¯„ä¾‹

```python
# 1. è¨­å®šæª”æ¡ˆè·¯å¾‘
model_path = r'path/to/best.pt'
image_base_folder = r'path/to/images'
image_names = ['test_image.png']

# 2. è¨­å®šæª¢æ¸¬åƒæ•¸
img_type = "lost"              # é¸æ“‡æª¢æ¸¬æ¨¡å¼
img_size = 320                 # åœ–ç‰‡å°ºå¯¸
conf_threshold = 0.3           # ä¿¡å¿ƒåº¦é–¾å€¼
standard_nms_threshold = 0.45  # æ¨™æº–NMS
overlap_nms_threshold = 0.8    # é‡ç–ŠNMS

# 3. è¼‰å…¥åœ–ç‰‡
cv_img_list = []
for image_name in image_names:
    image_path = os.path.join(image_base_folder, image_name)
    cv_img = load_image_path(image_path, img_size=img_size)
    cv_img_list.append(cv_img)

# 4. åŸ·è¡Œæª¢æ¸¬
detections = simple_detection_example(
    model_path=model_path,
    cv_img_list=cv_img_list,
    img_type=img_type,
    img_size=img_size,
    conf_threshold=conf_threshold,
    standard_nms_threshold=standard_nms_threshold,
    overlap_nms_threshold=overlap_nms_threshold
)

# 5. æŸ¥çœ‹çµæœ
print(f"æª¢æ¸¬çµæœ: {detections}")
```

### ğŸ”§ åƒæ•¸èª¿å„ªå»ºè­°

#### æª¢æ¸¬æ•ˆæœä¸ä½³æ™‚

**å•é¡Œï¼šæª¢æ¸¬ä¸åˆ°ç‰©ä»¶**
```python
# è§£æ±ºæ–¹æ¡ˆï¼šé™ä½ä¿¡å¿ƒåº¦é–¾å€¼
conf_threshold = 0.1  # å¾ 0.3 é™åˆ° 0.1
```

**å•é¡Œï¼šå¤ªå¤šèª¤æª¢**
```python
# è§£æ±ºæ–¹æ¡ˆï¼šæé«˜ä¿¡å¿ƒåº¦é–¾å€¼
conf_threshold = 0.5  # å¾ 0.3 æé«˜åˆ° 0.5
```

**å•é¡Œï¼šé‡ç–Šç‰©ä»¶è¢«éåº¦ç§»é™¤**
```python
# è§£æ±ºæ–¹æ¡ˆï¼šèª¿æ•´ NMS é–¾å€¼
standard_nms_threshold = 0.3     # é™ä½æ¨™æº–NMS
overlap_nms_threshold = 0.9      # æé«˜é‡ç–ŠNMS
```

**å•é¡Œï¼šå †ç–Šç‰©ä»¶æª¢æ¸¬ä¸æº–**
```python
# è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ lost æ¨¡å¼ä¸¦èª¿æ•´åƒæ•¸
img_type = "lost"
overlap_nms_threshold = 0.7      # é©åº¦é™ä½é‡ç–Šé–¾å€¼
```

### ğŸ“ˆ ä¸åŒå ´æ™¯çš„æ¨è–¦è¨­å®š

#### å ´æ™¯1ï¼šç²¾ç¢ºç›®æ¨™æª¢æ¸¬
```python
img_type = "target"
conf_threshold = 0.5
standard_nms_threshold = 0.4
overlap_nms_threshold = 0.7
```

#### å ´æ™¯2ï¼šéºå¤±ç‰©å“æœç´¢
```python
img_type = "lost"
conf_threshold = 0.2
standard_nms_threshold = 0.5
overlap_nms_threshold = 0.8
```

#### å ´æ™¯3ï¼šé«˜å¯†åº¦ç‰©ä»¶æª¢æ¸¬
```python
img_type = "lost"
conf_threshold = 0.3
standard_nms_threshold = 0.6
overlap_nms_threshold = 0.9
```

### âš ï¸ å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±º

1. **åœ–ç‰‡å°ºå¯¸ä¸åŒ¹é…**
   ```python
   # éŒ¯èª¤ï¼šä½¿ç”¨èˆ‡è¨“ç·´æ™‚ä¸åŒçš„å°ºå¯¸
   img_size = 640  # è¨“ç·´æ™‚ä½¿ç”¨320
   
   # æ­£ç¢ºï¼šä½¿ç”¨èˆ‡è¨“ç·´æ™‚ç›¸åŒçš„å°ºå¯¸
   img_size = 320  # èˆ‡è¨“ç·´æ™‚ä¸€è‡´
   ```

2. **è·¯å¾‘è¨­å®šéŒ¯èª¤**
   ```python
   # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
   import os
   assert os.path.exists(model_path), f"æ¨¡å‹æª”æ¡ˆä¸å­˜åœ¨: {model_path}"
   assert os.path.exists(image_path), f"åœ–ç‰‡æª”æ¡ˆä¸å­˜åœ¨: {image_path}"
   ```

3. **è¨˜æ†¶é«”ä¸è¶³**
   ```python
   # æ¸›å°‘æ‰¹æ¬¡è™•ç†åœ–ç‰‡æ•¸é‡
   image_names = ['single_image.png']  # ä¸€æ¬¡è™•ç†ä¸€å¼µåœ–ç‰‡
   ```

---
